version: '3.8'

services:
  # ============================================
  # KEYCLOAK - Basado en configuraci√≥n de Compras
  # ============================================
  keycloak-db:
    image: postgres:16.2
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d keycloak -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ds-network

  keycloak:
    image: quay.io/keycloak/keycloak:23.0.6
    container_name: keycloak
    command: start-dev --import-realm
    environment:
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    volumes:
      - ./2025-TPI/keycloak/realm-config:/opt/keycloak/data/import:ro
    depends_on:
      keycloak-db:
        condition: service_healthy
    networks:
      - ds-network

  # ============================================
  # GRUPO 2 - STOCK (NOSOTROS)
  # ============================================
  stock-backend:
    image: ghcr.io/frre-ds/backend-stock-g02:latest
    container_name: stock-backend
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      SUPABASE_URL: https://tznhwyxgkbkhrfjldmfz.supabase.co
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6bmh3eXhna2JraHJmamxkbWZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MzcxNjMsImV4cCI6MjA3NTAxMzE2M30.DOcz00RPnRBdDj3rWq9MMT5KUDmcA21KJtT2CWNHwZU
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: ds-2025-realm
      KEYCLOAK_CLIENT_ID: grupo-02
      KEYCLOAK_CLIENT_SECRET: 58536bf8-8501-41c9-b411-786b6d654c25
    depends_on:
      - keycloak
    networks:
      - ds-network

  stock-frontend:
    image: ghcr.io/frre-ds/frontend-stock-g02:latest
    container_name: stock-frontend
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://stock-backend:4000/api
      NEXT_PUBLIC_KEYCLOAK_URL: http://keycloak:8080
      NEXT_PUBLIC_KEYCLOAK_REALM: ds-2025-realm
      NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: grupo-02
    depends_on:
      - stock-backend
      - keycloak
    networks:
      - ds-network

  # ============================================
  # GRUPO 4 - COMPRAS
  # ============================================
  compras-db:
    image: postgres:16.2
    container_name: compras_postgres
    environment:
      POSTGRES_DB: compras_db
      POSTGRES_USER: compras_user
      POSTGRES_PASSWORD: compras_password
    volumes:
      - compras_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U compras_user -d compras_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ds-network

  compras-backend:
    image: ghcr.io/frre-ds/backend-compras-g04:v1.0.1
    container_name: compras-backend
    environment:
      SITE_URL: http://localhost
      APP_PATH_PREFIX: /compras
      BASE_API_URL: http://nginx/compras/api/
      PRODUCTOS_API_BASE_URL: http://nginx/stock/api
      USE_MOCK_APIS: "false"
      USE_SQLITE: "false"
      POSTGRES_DB: compras_db
      POSTGRES_USER: compras_user
      POSTGRES_PASSWORD: compras_password
      POSTGRES_HOST: compras-db
      POSTGRES_PORT: 5432
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_PUBLIC_BASE_URL: http://localhost:8080
      KEYCLOAK_REALM: ds-2025-realm
      KEYCLOAK_CLIENT_ID: grupo-04
      KEYCLOAK_CLIENT_SECRET: 6be1bec1-9472-499f-ab37-883d78f57829
      KEYCLOAK_EXPECTED_AUDIENCE: account,grupo-04
      KEYCLOAK_SERVICE_CLIENT_ID: grupo-04
      KEYCLOAK_SERVICE_CLIENT_SECRET: 6be1bec1-9472-499f-ab37-883d78f57829
      KEYCLOAK_SERVICE_SCOPE: ""
      STOCK_API_BASE_URL: http://nginx/stock/
      LOGISTICA_API_BASE_URL: http://shipping-back:3010
    command: >
      /bin/sh -c "
      echo 'üîÑ Esperando a PostgreSQL...' &&
      sleep 5 &&
      echo 'üì¶ Aplicando migraciones...' &&
      python manage.py migrate --noinput &&
      echo 'üìÅ Recolectando archivos est√°ticos...' &&
      python manage.py collectstatic --noinput &&
      echo 'üöÄ Iniciando Gunicorn...' &&
      gunicorn Main.wsgi:application --bind 0.0.0.0:8000 --workers 3
      "
    volumes:
      - compras_static:/app/staticfiles
      - compras_media:/app/media
    expose:
      - "8000"
    depends_on:
      compras-db:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - ds-network

  # ============================================
  # GRUPO 3 - LOG√çSTICA
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: shipping_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shipping_db
      MYSQL_USER: shipping_user
      MYSQL_PASSWORD: shipping_pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "shipping_user", "-pshipping_pass"]
      interval: 3s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - ds-network

  shipping-back:
    image: ghcr.io/frre-ds/2025-grupo-03-backend-logistica:latest
    container_name: shipping_back
    restart: always
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: shipping_user
      DB_PASSWORD: shipping_pass
      DB_DATABASE: shipping_db
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: ds-2025-realm
      KEYCLOAK_CLIENT_ID: grupo-03
      KEYCLOAK_CLIENT_SECRET: 21cd6616-6571-4ee7-be29-0f781f77c74e
    extra_hosts:
      - "localhost:host-gateway"
    depends_on:
      mysql:
        condition: service_healthy
    expose:
      - "3010"
    networks:
      - ds-network

  # ============================================
  # NGINX - API GATEWAY √öNICO PARA TODOS
  # ============================================
  nginx:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: nginx
    ports:
      - "80:80"
    depends_on:
      - compras-backend
      - stock-backend
      - shipping-back
    volumes:
      - compras_static:/app/staticfiles:ro
      - compras_media:/app/media:ro
    networks:
      - ds-network

networks:
  ds-network:
    driver: bridge

volumes:
  keycloak_data:
  compras_data:
  compras_static:
  compras_media:
  mysql_data:
